<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agente Gemini</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); }
        .entry { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Estilo para las pesta√±as de la gu√≠a */
        .tab-button.active {
            background-color: var(--tw-color-blue-100, #DBEAFE);
            color: var(--tw-color-blue-800, #1E40AF);
        }
        .dark .tab-button.active {
            background-color: var(--tw-color-blue-700, #1D4ED8);
            color: var(--tw-color-blue-200, #BFDBFE);
        }
    </style>
    <link rel="stylesheet" href="/static/style.css"> 
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-300">

<div class="container mx-auto p-4 md:p-8 flex flex-col md:flex-row h-screen">

    <div class="flex-1 bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 flex flex-col mr-0 md:mr-6 mb-6 md:mb-0 transition-colors duration-300">

        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-blue-600 dark:text-blue-400">ü§ñ Agente Gemini</h1>
            <div class="flex items-center space-x-2">
                <button id="guide-button" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 focus:outline-none hover:ring-2 ring-blue-500">‚ùì</button>
                <button id="theme-toggle" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 focus:outline-none hover:ring-2 ring-blue-500">
                    <span id="theme-icon">üåô</span>
                </button>
            </div>
        </div>

        <div id="content-area" class="flex-1 overflow-y-auto scrollbar-hide">
            
            <div id="history" class="space-y-4">
                </div>
        </div>

        <div id="loading-indicator" class="hidden text-center py-2">
            <div class="text-blue-600 dark:text-blue-400">ü§ñ Procesando...</div>
        </div>

        <div class="mt-6">
            <form id="commandForm" class="flex space-x-2">
                <input type="text" id="user_input" placeholder="Escribe tu comando aqu√≠..." 
                        class="flex-1 px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg 
                                 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 
                                 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-300">
                <button type="submit" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-300">
                    Enviar
                </button>
            </form>
        </div>
    </div>

    <div class="w-full md:w-80 bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 transition-colors duration-300">
        <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-200">üìä Panel de Control</h2>

        
<div id="notifications-section">
            <h3 class="font-semibold text-lg text-gray-700 dark:text-gray-300 mb-2">üîî Notificaciones</h3>
            <div class="space-y-2 mb-4">
                <button onclick="configureNotifications()" 
                         class="block w-full text-center p-2 bg-purple-500 hover:bg-purple-600 text-white font-semibold rounded-lg transition-colors">
                    ‚öôÔ∏è Configurar
                </button>
                <button onclick="testNotifications()" 
                         class="block w-full text-center p-2 bg-gray-500 hover:bg-gray-600 text-white font-semibold rounded-lg transition-colors">
                    üß™ Probar
                </button>
                
            </div>
        </div>

        
        <div class="mb-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
            <h3 class="font-medium text-gray-800 dark:text-gray-200 mb-2">üîî Notificaciones</h3>
            <p class="text-sm text-gray-600 dark:text-gray-300" id="notification-status">Estado: Iniciando...</p>
        </div>

        <div class="mb-6">
            <h3 class="font-semibold text-lg text-gray-700 dark:text-gray-300 mb-3">üìÅ Archivos Guardados</h3>
            
            <div class="mb-4">
                <h4 class="font-medium text-gray-600 dark:text-gray-400 mb-2">üíª C√≥digo</h4>
                <div id="code-files-list">
                    <p class="text-sm text-gray-500 dark:text-gray-400 italic text-center">Cargando...</p>
                </div>
            </div>
            
            <div id="notes-section">
                <h4 class="font-medium text-gray-600 dark:text-gray-400 mb-2">üìù Notas</h4>
                <p class="text-sm text-gray-500 dark:text-gray-400 italic text-center">Cargando...</p>
            </div>
        </div>

        <div class="mb-4">
            <button id="rmn-toggle" onclick="toggleRMNSection()" 
                     class="w-full p-3 bg-gradient-to-r from-teal-500 to-cyan-600 text-white rounded-lg hover:from-teal-600 hover:to-cyan-700 transition-all duration-300 font-medium">
                üß™ Espectros RMN ‚ñ∂
            </button>
        </div>

        <div id="rmn-section" class="hidden space-y-3 mb-4">
            <div class="p-3 bg-teal-50 dark:bg-teal-900 rounded-lg">
                <h4 class="font-medium text-teal-800 dark:text-teal-200 mb-2">üìä Estad√≠sticas RMN</h4>
                <p class="text-xs text-teal-600 dark:text-teal-300" id="rmn-stats">Espectros: 0 | Limpios: 0 | Gr√°ficos: 0</p>
            </div>

            <div class="space-y-2">
                <button onclick="showRMNHelp()" 
                         class="w-full p-2 bg-teal-100 dark:bg-teal-800 text-teal-800 dark:text-teal-200 rounded text-sm hover:bg-teal-200 dark:hover:bg-teal-700 transition-colors">
                    ‚ùì Ayuda RMN
                </button>
                
                <button onclick="showRMNMethods()" 
                         class="w-full p-2 bg-teal-100 dark:bg-teal-800 text-teal-800 dark:text-teal-200 rounded text-sm hover:bg-teal-200 dark:hover:bg-teal-700 transition-colors">
                    üß™ M√©todos disponibles
                </button>
                
                <button onclick="listSpectra()" 
                         class="w-full p-2 bg-teal-100 dark:bg-teal-800 text-teal-800 dark:text-teal-200 rounded text-sm hover:bg-teal-200 dark:hover:bg-teal-700 transition-colors">
                    üìã Listar espectros
                </button>
            </div>

            <div class="p-2 bg-gray-50 dark:bg-gray-700 rounded">
                <h5 class="text-xs font-medium text-gray-700 dark:text-gray-300 mb-2">‚ö° Comandos r√°pidos:</h5>
                <div class="grid grid-cols-2 gap-1">
                    <button onclick="quickCleanAuto()" 
                             class="px-2 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600 transition-colors">
                        Auto
                    </button>
                    <button onclick="quickCleanSavgol()" 
                             class="px-2 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600 transition-colors">
                        Savgol
                    </button>
                    <button onclick="quickCleanGaussian()" 
                             class="px-2 py-1 bg-yellow-500 text-white text-xs rounded hover:bg-yellow-600 transition-colors">
                        Gaussian
                    </button>
                    <button onclick="quickCleanMedian()" 
                             class="px-2 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600 transition-colors">
                        Median
                    </button>
                </div>
            </div>

            <div class="p-3 border-2 border-dashed border-teal-300 dark:border-teal-600 rounded-lg">
                <input type="file" id="spectrum-upload" accept=".csv,.txt,.dat,.asc" class="hidden" 
                        onchange="uploadSpectrum(event)">
                <button onclick="document.getElementById('spectrum-upload').click()" 
                         class="w-full p-2 text-teal-600 dark:text-teal-400 text-sm hover:bg-teal-50 dark:hover:bg-teal-900 rounded transition-colors">
                    üìÅ Subir Espectro
                </button>
            </div>

            <div id="cleaned-spectra" class="space-y-3">
                <div class="text-xs text-gray-500 dark:text-gray-400 italic text-center">
                    Todav√≠a no hay espectros limpios
                </div>
            </div>
        </div>

        <div class="mb-4">
            <button id="document-toggle" onclick="toggleDocumentSection()" 
                     class="w-full p-3 bg-gradient-to-r from-orange-500 to-yellow-600 text-white rounded-lg hover:from-orange-600 hover:to-yellow-700 transition-all duration-300 font-medium">
                üìÑ Documentos ‚ñ∂
            </button>
        </div>

        <div id="document-section" class="hidden space-y-3 mb-4">
            <div class="p-3 bg-orange-50 dark:bg-orange-900 rounded-lg">
                <h4 class="font-medium text-orange-800 dark:text-orange-200 mb-2">üìä Estad√≠sticas</h4>
                <p class="text-xs text-orange-600 dark:text-orange-300" id="document-stats">Plantillas: 0 | Datos: 0 | Generados: 0</p>
            </div>

            <div class="space-y-3">
                <div class="border border-orange-200 dark:border-orange-700 rounded-lg overflow-hidden">
                    <button onclick="toggleDocumentTab('templates')" 
                             class="w-full p-2 bg-orange-100 dark:bg-orange-800 text-orange-800 dark:text-orange-200 font-medium text-sm hover:bg-orange-200 dark:hover:bg-orange-700 transition-colors">
                        üìÑ Plantillas <span id="templates-toggle">‚ñº</span>
                    </button>
                    <div id="templates-content" class="p-2 bg-white dark:bg-gray-800 max-h-40 overflow-y-auto">
                        <div id="templates-list">
                            <p class="text-xs text-gray-500 italic text-center">Cargando...</p>
                        </div>
                        <div class="mt-2 p-2 border-2 border-dashed border-orange-300 dark:border-orange-600 rounded">
                            <input type="file" id="template-file-input" accept=".docx,.txt,.pdf" class="hidden" onchange="uploadTemplate()">
                            <button onclick="document.getElementById('template-file-input').click()" 
                                     class="w-full p-1 text-orange-600 dark:text-orange-400 text-xs hover:bg-orange-50 dark:hover:bg-orange-900 rounded">
                                üìÅ Subir Plantilla
                            </button>
                        </div>
                    </div>
                </div>

                <div class="border border-green-200 dark:border-green-700 rounded-lg overflow-hidden">
                    <button onclick="toggleDocumentTab('data')" 
                             class="w-full p-2 bg-green-100 dark:bg-green-800 text-green-800 dark:text-green-200 font-medium text-sm hover:bg-green-200 dark:hover:bg-green-700 transition-colors">
                        üìä Datos <span id="data-toggle">‚ñ∂</span>
                    </button>
                    <div id="data-content" class="hidden p-2 bg-white dark:bg-gray-800 max-h-40 overflow-y-auto">
                        <div id="data-files-list">
                            <p class="text-xs text-gray-500 italic text-center">Cargando...</p>
                        </div>
                        <div class="mt-2 p-2 border-2 border-dashed border-green-300 dark:border-green-600 rounded">
                            <input type="file" id="data-file-input" accept=".json,.csv,.xlsx,.txt" class="hidden" onchange="uploadDataFile()">
                            <button onclick="document.getElementById('data-file-input').click()" 
                                     class="w-full p-1 text-green-600 dark:text-green-400 text-xs hover:bg-green-50 dark:hover:bg-green-900 rounded">
                                üìÅ Subir Datos
                            </button>
                        </div>
                    </div>
                </div>

                <div class="border border-yellow-200 dark:border-yellow-700 rounded-lg overflow-hidden">
                    <button onclick="toggleDocumentTab('output')" 
                             class="w-full p-2 bg-yellow-100 dark:bg-yellow-800 text-yellow-800 dark:text-yellow-200 font-medium text-sm hover:bg-yellow-200 dark:hover:bg-yellow-700 transition-colors">
                        üìÅ Generados <span id="output-toggle">‚ñ∂</span>
                    </button>
                    <div id="output-content" class="hidden p-2 bg-white dark:bg-gray-800 max-h-40 overflow-y-auto">
                        <div id="output-files-list">
                            <p class="text-xs text-gray-500 italic text-center">Cargando...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<div id="guide-keywords-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
    <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 z-50 max-w-4xl w-full max-h-[90vh] overflow-y-auto scrollbar-hide">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200">üìò Gu√≠a de Uso y Palabras Clave del Agente</h2>
            <button id="close-guide-keywords-modal" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 focus:outline-none">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <div class="mb-4 flex space-x-2">
            <button class="tab-button active px-4 py-2 bg-blue-100 dark:bg-blue-700 rounded-xl focus:outline-none" data-tab="tools">Herramientas</button>
            <button class="tab-button px-4 py-2 bg-gray-100 dark:bg-gray-600 rounded-xl focus:outline-none" data-tab="keywords">Palabras Clave</button>
        </div>

        <div id="tab-tools" class="tab-content">
            <div class="p-4 bg-yellow-100 dark:bg-yellow-800 rounded-xl mb-4">
                <h3 class="font-bold text-yellow-800 dark:text-yellow-100 text-lg">üìù Note (Notas)</h3>
                <p class="mt-2">Maneja tus notas personales. Se guardan autom√°ticamente con fecha y hora.</p>
                <ul class="mt-2 list-disc list-inside text-sm">
                    <li><strong>Guardar nota:</strong> <code>guardar: tu nota aqu√≠</code></li>
                    <li><strong>Ver todas:</strong> <code>leer</code></li>
                    <li><strong>Buscar:</strong> <code>buscar: t√©rmino</code></li>
                    <li><strong>Contar:</strong> <code>contar</code></li>
                    <li><strong>Borrar todas:</strong> <code>borrar</code></li>
                    <li><strong>Descargar:</strong> <code>descargar</code></li>
                </ul>
            </div>

            <div class="p-4 bg-green-100 dark:bg-green-800 rounded-xl mb-4">
                <h3 class="font-bold text-green-800 dark:text-green-100 text-lg">üíª Save Code (Guardar C√≥digo)</h3>
                <p class="mt-2">Guarda snippets de c√≥digo en la carpeta de archivos.</p>
                <ul class="mt-2 list-disc list-inside text-sm">
                    <li><strong>Formato:</strong> <code>nombre_archivo||contenido_del_codigo</code></li>
                    <li><strong>Ejemplo:</strong> <code>script.py||print("Hola Mundo")</code></li>
                    <li><strong>Otro ejemplo:</strong> <code>calculadora.py||def suma(a,b): return a+b</code></li>
                </ul>
            </div>

            <div class="p-4 bg-purple-100 dark:bg-purple-800 rounded-xl mb-4">
                <h3 class="font-bold text-purple-800 dark:text-purple-100 text-lg">‚öôÔ∏è Code Gen (Generar C√≥digo)</h3>
                <p class="mt-2">Genera c√≥digo autom√°ticamente usando IA y lo guarda autom√°ticamente.</p>
                <ul class="mt-2 list-disc list-inside text-sm">
                    <li><strong>Formato b√°sico:</strong> <code>generar: un script en Python que diga hola mundo</code></li>
                    <li><strong>Con nombre personalizado:</strong> <code>mi_script.py||generar un script que haga una calculadora</code></li>
                    <li><strong>Solo descripci√≥n:</strong> <code>crear una funci√≥n que sume n√∫meros</code></li>
                </ul>
            </div>

            <div class="p-4 bg-indigo-100 dark:bg-indigo-800 rounded-xl mb-4">
                <h3 class="font-bold text-indigo-800 dark:text-indigo-100 text-lg">üßÆ Calculator (Calculadora)</h3>
                <p class="mt-2">Eval√∫a expresiones matem√°ticas complejas.</p>
                <ul class="mt-2 list-disc list-inside text-sm">
                    <li><strong>Ejemplo:</strong> <code>2 + 2 * (3 - 1)</code> devuelve <code>6</code></li>
                    <li><strong>Otro ejemplo:</strong> <code>(100 / 2) ** 2</code> devuelve <code>2500.0</code></li>
                </ul>
            </div>

            <div class="p-4 bg-blue-100 dark:bg-blue-800 rounded-xl mb-4">
                <h3 class="font-bold text-blue-800 dark:text-blue-100 text-lg">üîç Web Search (B√∫squeda en la web)</h3>
                <p class="mt-2">Busca en internet y devuelve los 5 primeros resultados. (Requiere el uso de la herramienta `google:search`)</p>
                <ul class="mt-2 list-disc list-inside text-sm">
                    <li><strong>Ejemplo:</strong> <code>buscar noticias de inteligencia artificial</code></li>
                    <li><strong>Otro ejemplo:</strong> <code>buscar patentes sobre energ√≠a solar</code></li>
                </ul>
            </div>

            <div class="p-4 bg-red-100 dark:bg-red-800 rounded-xl mb-4">
                <h3 class="font-bold text-red-800 dark:text-red-100 text-lg">üåê Web Open (Abrir Enlaces)</h3>
                <p class="mt-2">Abre una URL directamente en tu navegador (asumiendo funci√≥n de backend).</p>
                <ul class="mt-2 list-disc list-inside text-sm">
                    <li><strong>Ejemplo:</strong> <code>https://www.wikipedia.org</code></li>
                    <li><strong>Otro ejemplo:</strong> <code>wikipedia.org</code> (agrega https autom√°ticamente)</li>
                </ul>
            </div>
        </div>

        <div id="tab-keywords" class="tab-content hidden">
            <div class="mb-4">
                <h3 class="font-semibold text-teal-700 dark:text-teal-300">üß™ RMN Spectrum Cleaner</h3>
                <p class="mt-1 font-mono bg-gray-100 dark:bg-gray-700 p-2 rounded-lg overflow-x-auto text-xs">
                    rmn, espectro, espectros, resonancia, ruido, limpiar espectro, filtrar, savgol, gaussian, mediana, wiener, l√≠nea base, snr, ppm, intensidad, picos, analizar espectro, comparar espectro, pfos, pfas, contaminante, array, cromatografia, espectrometria, masas, gc-ms, lc-ms
                </p>
            </div>
            
            <div class="mb-4">
                <h3 class="font-semibold text-blue-700 dark:text-blue-300">üíª Generaci√≥n de C√≥digo</h3>
                <p class="mt-1 font-mono bg-gray-100 dark:bg-gray-700 p-2 rounded-lg overflow-x-auto text-xs">
                    generar, genera, crear, crea, escribir, escribe, codigo, c√≥digo, script, programa, funci√≥n, funcion, algoritmo, clase, app, aplicaci√≥n, aplicacion
                </p>
            </div>

            <div class="mb-4">
                <h3 class="font-semibold text-green-700 dark:text-green-300">üîî Notificaciones</h3>
                <p class="mt-1 font-mono bg-gray-100 dark:bg-gray-700 p-2 rounded-lg overflow-x-auto text-xs">
                    listar, listar 10, listar 20, listar papers, listar patentes, listar patents, ver, mostrar, ver recientes, √∫ltimas, √∫ltimos, recientes, resumen, desglose, borrar, eliminar, borrar papers, eliminar papers, borrar todo, eliminar todo, limpiar, reset, clear, papers, patentes, emails, notificaciones, tipo, tipos, ID, id, identificador, ref, referencia, gestionar, administrar, control, verificar, consultar, notificacion, notificaci√≥n, alerta, avisar, aviso, email, correo, patente, paper, cient√≠fico, monitoreo, notificar, activar, keywords, categories, status, estado, test, probar
                </p>
            </div>

            <div class="mb-4">
                <h3 class="font-semibold text-purple-700 dark:text-purple-300">üìÑ Documentos</h3>
                <p class="mt-1 font-mono bg-gray-100 dark:bg-gray-700 p-2 rounded-lg overflow-x-auto text-xs">
                    plantilla, rellenar, documento, formulario, listar plantillas, listar datos, analizar, crear ejemplo, ayuda, subvencion, subvenci√≥n, document_filler, plantillas, datos, rellenar:
                </p>
            </div>
        </div>
    </div>
</div>


<script src="/static/script.js"></script>
<script type="module" src="/static/js/rmn.js"></script>
<script type="module" src="/static/js/document.js"></script>

<script>
// =============================================================================
// VARIABLES GLOBALES (para evitar referencias a scripts externos no cargados)
// Asumo que estas funciones existen en /static/script.js
// function configureNotifications() { /* ... */ }
// function testNotifications() { /* ... */ }
// =============================================================================

const commandForm = document.getElementById('commandForm');
const userInput = document.getElementById('user_input');
const guideKeywordsModal = document.getElementById("guide-keywords-modal");
const guideButton = document.getElementById("guide-button");
const closeGuideKeywordsButton = document.getElementById("close-guide-keywords-modal");

// =============================================================================
// MANEJO DE LA GU√çA Y TABS DEL MODAL
// =============================================================================

guideButton.addEventListener("click", () => guideKeywordsModal.classList.remove("hidden"));
closeGuideKeywordsButton.addEventListener("click", () => guideKeywordsModal.classList.add("hidden"));
guideKeywordsModal.addEventListener("click", (e) => {
    if(e.target === guideKeywordsModal) guideKeywordsModal.classList.add("hidden");
});

const tabButtons = document.querySelectorAll(".tab-button");
const tabContents = document.querySelectorAll(".tab-content");

function switchTab(targetTab) {
    tabContents.forEach(tc => tc.classList.add("hidden"));
    tabButtons.forEach(b => b.classList.remove("active", "bg-blue-100", "dark:bg-blue-700"));
    tabButtons.forEach(b => b.classList.add("bg-gray-100", "dark:bg-gray-600"));
    
    document.getElementById("tab-" + targetTab).classList.remove("hidden");
    const activeBtn = document.querySelector(`.tab-button[data-tab="${targetTab}"]`);
    activeBtn.classList.remove("bg-gray-100", "dark:bg-gray-600");
    activeBtn.classList.add("active", "bg-blue-100", "dark:bg-blue-700");
}

tabButtons.forEach(btn => {
    btn.addEventListener("click", () => switchTab(btn.dataset.tab));
});

// Asegurarse de que el tab de herramientas est√© activo al inicio
document.addEventListener('DOMContentLoaded', () => {
    switchTab('tools');
});

// =============================================================================
// FUNCIONES AUXILIARES PARA MENSAJES (MITIGACI√ìN XSS)
// =============================================================================

function createMessageEntry(type, icon, message) {
    const historyDiv = document.getElementById('history');
    const entry = document.createElement('div');
    entry.className = `entry p-4 rounded-lg shadow-md border-l-4 mb-4 
                       ${type === 'success' ? 'bg-green-100 dark:bg-green-800 border-green-500' :
                         type === 'error'   ? 'bg-red-100 dark:bg-red-800 border-red-500' :
                         'bg-blue-100 dark:bg-blue-800 border-blue-500'}`;
    
    const contentDiv = document.createElement('div');
    contentDiv.className = `font-bold ${type === 'success' ? 'text-green-800 dark:text-green-200' :
                                      type === 'error'   ? 'text-red-800 dark:text-red-200' :
                                      'text-blue-800 dark:text-blue-200'}`;
    contentDiv.textContent = `${icon} ${message}`;
    
    entry.appendChild(contentDiv);
    historyDiv.prepend(entry);
    
    setTimeout(() => entry.remove(), 7000);
}

function showSuccessMessage(message) {
    createMessageEntry('success', '‚úÖ', message);
}

function showErrorMessage(message) {
    createMessageEntry('error', '‚ùå', message);
}

function showInfoMessage(message) {
    createMessageEntry('info', 'üí°', message);
}


// =============================================================================
// FUNCIONES DE CONTROL RMN (SOBREESCRITAS para enviar comandos al chat)
// =============================================================================

function toggleRMNSection() {
    const section = document.getElementById('rmn-section');
    const button = document.getElementById('rmn-toggle');
    
    if (section.classList.contains('hidden')) {
        section.classList.remove('hidden');
        button.innerHTML = 'üß™ Espectros RMN ‚ñº';
        loadRMNStats();
    } else {
        section.classList.add('hidden');
        button.innerHTML = 'üß™ Espectros RMN ‚ñ∂';
    }
}

function showRMNHelp() { userInput.value = 'ayuda rmn'; commandForm.dispatchEvent(new Event('submit')); }
function showRMNMethods() { userInput.value = 'm√©todos'; commandForm.dispatchEvent(new Event('submit')); }
function listSpectra() { userInput.value = 'listar espectros'; commandForm.dispatchEvent(new Event('submit')); }
function quickCleanAuto() { userInput.value = 'limpiar auto'; commandForm.dispatchEvent(new Event('submit')); }
function quickCleanSavgol() { userInput.value = 'limpiar con savgol'; commandForm.dispatchEvent(new Event('submit')); }
function quickCleanGaussian() { userInput.value = 'limpiar con gaussian'; commandForm.dispatchEvent(new Event('submit')); }
function quickCleanMedian() { userInput.value = 'limpiar con median'; commandForm.dispatchEvent(new Event('submit')); }
function analyzeCleanSpectrum(filename) { userInput.value = `analizar: ${filename}`; commandForm.dispatchEvent(new Event('submit')); }
function compareSpectra(filename) { userInput.value = `comparar: ${filename}`; commandForm.dispatchEvent(new Event('submit')); }


async function uploadSpectrum(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const formData = new FormData();
    formData.append('file', file);

    try {
        // Asumo que hay una funci√≥n de backend /upload/spectrum
        const response = await fetch('/upload/spectrum', { method: 'POST', body: formData });
        const result = await response.json();
        
        if (result.success) {
            showSuccessMessage(result.message);
            if (result.next_step) { showInfoMessage(`üí° Siguiente paso: ${result.next_step}`); }
            loadRMNStats();
            event.target.value = '';
        } else {
            showErrorMessage(result.error || 'Error subiendo espectro');
        }
    } catch (error) {
        showErrorMessage(`Error de red subiendo espectro: ${error.message}`);
    }
}

async function loadRMNStats() {
    try {
        // Asumo que hay una funci√≥n de backend /files/spectra
        const response = await fetch('/files/spectra');
        const data = await response.json();
        
        const statsElement = document.getElementById('rmn-stats');
        if (statsElement) {
            const spectraCount = data.spectra ? data.spectra.length : 0;
            const cleanedCount = data.cleaned ? data.cleaned.length : 0;
            const plotsCount = data.plots ? data.plots.length : 0;
            
            statsElement.textContent = `Espectros: ${spectraCount} | Limpios: ${cleanedCount} | Gr√°ficos: ${plotsCount}`;
        }
        // Llamar a loadCleanedSpectra aqu√≠ o desde el backend si es necesario
    } catch (error) {
        console.error('Error cargando estad√≠sticas RMN:', error);
    }
}

function showCleanResult(result) {
    const container = document.getElementById('cleaned-spectra');
    if (!container) return;

    // Eliminar mensaje de "no hay espectros limpios" si existe
    const emptyMsg = container.querySelector('div.text-xs.italic');
    if (emptyMsg) emptyMsg.remove();

    const cleanFileName = result.cleaned_file ? result.cleaned_file.split('/').pop() : 'Archivo desconocido';
    const plotFileName = result.plot_file ? result.plot_file.split('/').pop() : null;
    
    const paramsStr = result.params ? 
        Object.entries(result.params).map(([key, value]) => `${key}: ${value}`).join(', ') : 
        'Par√°metros autom√°ticos';

    const entry = document.createElement('div');
    entry.className = 'p-4 bg-gradient-to-r from-green-50 to-blue-50 dark:from-green-900 dark:to-blue-900 rounded-lg shadow-md border-l-4 border-green-500 mb-4';
    entry.innerHTML = `
        <div class="flex justify-between items-start mb-3">
            <div class="flex items-center space-x-3">
                <div class="text-2xl">üß™</div>
                <div>
                    <div class="text-green-800 dark:text-green-200 font-bold text-lg">ESPECTRO LIMPIADO</div>
                    <div class="text-xs text-green-600 dark:text-green-400">
                        ${new Date().toLocaleString('es-ES')}
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm mb-4">
            <div class="space-y-1">
                <div class="flex justify-between">
                    <span class="text-gray-600 dark:text-gray-400">Archivo original:</span>
                    <span class="font-mono text-gray-800 dark:text-gray-200">${result.original_file}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600 dark:text-gray-400">Archivo limpio:</span>
                    <span class="font-mono text-green-700 dark:text-green-300">${cleanFileName}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600 dark:text-gray-400">M√©todo:</span>
                    <span class="font-semibold text-blue-600 dark:text-blue-400">${result.method}</span>
                </div>
            </div>
            <div class="space-y-1">
                <div class="flex justify-between">
                    <span class="text-gray-600 dark:text-gray-400">Mejora SNR:</span>
                    <span class="font-semibold text-green-600 dark:text-green-400">+${result.snr_improvement || '0'} dB</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600 dark:text-gray-400">Par√°metros:</span>
                    <span class="text-xs text-gray-700 dark:text-gray-300">${paramsStr}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600 dark:text-gray-400">Estado:</span>
                    <span class="text-green-600 dark:text-green-400 font-semibold">‚úÖ Listo</span>
                </div>
            </div>
        </div>

        <div class="flex flex-wrap gap-2 pt-3 border-t border-green-200 dark:border-green-700">
            <a href="/download/cleaned/${encodeURIComponent(cleanFileName)}" download
               class="flex items-center px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors">
                üì• Descargar CSV Limpio
            </a>
            
            ${result.plot_file ? `
            <a href="/download/plot/${encodeURIComponent(plotFileName)}" download
               class="flex items-center px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors">
                üìä Descargar Gr√°fico
            </a>
            ` : ''}

            <button onclick="analyzeCleanSpectrum('${cleanFileName}')" 
                      class="flex items-center px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg transition-colors">
                üîç Analizar
            </button>

            <button onclick="compareSpectra('${result.original_file}')" 
                      class="flex items-center px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg transition-colors">
                üìä Comparar
            </button>
        </div>

        <div class="mt-3 text-xs text-gray-500 dark:text-gray-400 flex justify-between">
            <span>üí° Haz clic en "Analizar" para ver estad√≠sticas detalladas</span>
            <span>üïí Procesado en ${result.processing_time || '0'}s</span>
        </div>
    `;

    container.prepend(entry);
    loadRMNStats();
}

// =============================================================================
// FUNCIONES DE CONTROL DE DOCUMENTOS
// =============================================================================

function toggleDocumentSection() {
    const section = document.getElementById('document-section');
    const button = document.getElementById('document-toggle');
    
    if (section.classList.contains('hidden')) {
        section.classList.remove('hidden');
        button.innerHTML = 'üìÑ Documentos ‚ñº';
        loadDocumentFiles();
    } else {
        section.classList.add('hidden');
        button.innerHTML = 'üìÑ Documentos ‚ñ∂';
    }
}

function toggleDocumentTab(tab) {
    const content = document.getElementById(`${tab}-content`);
    const toggle = document.getElementById(`${tab}-toggle`);
    
    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        toggle.textContent = '‚ñº';
    } else {
        content.classList.add('hidden');
        toggle.textContent = '‚ñ∂';
    }
}

function analyzeTemplate(filename) {
    userInput.value = `analizar: ${filename}`;
    commandForm.dispatchEvent(new Event('submit'));
}

// Funciones de carga (corregido XSS usando textContent)

function updateTemplatesList(templates) {
    const container = document.getElementById('templates-list');
    if (!container) return;
    
    if (templates.length === 0) {
        container.innerHTML = '<p class="text-xs text-gray-500 italic text-center">No hay plantillas</p>';
        return;
    }
    
    container.innerHTML = '';
    templates.forEach(file => {
        const div = document.createElement('div');
        div.className = 'flex justify-between items-center p-1 bg-gray-50 dark:bg-gray-700 rounded mb-1';
        
        const nameSpan = document.createElement('span');
        nameSpan.className = 'text-xs font-medium text-gray-800 dark:text-gray-200 truncate';
        // Usar textContent para mitigar XSS
        nameSpan.textContent = file.name; 
        
        div.appendChild(nameSpan);
        div.innerHTML += `
            <div class="flex space-x-1 ml-1">
                <button onclick="analyzeTemplate('${file.name}')" class="text-blue-600 hover:text-blue-800 text-sm" title="Analizar">üîç</button>
                <a href="/download/template/${encodeURIComponent(file.name)}" class="text-gray-600 hover:text-gray-800 text-sm" title="Descargar">‚¨áÔ∏è</a>
            </div>
        `;
        container.appendChild(div);
    });
}

// Repetir el patr√≥n de mitigaci√≥n XSS para otras listas (updateDataFilesList, updateOutputFilesList)
function updateDataFilesList(dataFiles) {
    const container = document.getElementById('data-files-list');
    if (!container) return;
    
    if (dataFiles.length === 0) {
        container.innerHTML = '<p class="text-xs text-gray-500 italic text-center">No hay archivos de datos</p>';
        return;
    }
    
    container.innerHTML = '';
    dataFiles.forEach(file => {
        const div = document.createElement('div');
        div.className = 'flex justify-between items-center p-1 bg-gray-50 dark:bg-gray-700 rounded mb-1';
        
        const nameSpan = document.createElement('span');
        nameSpan.className = 'text-xs font-medium text-gray-800 dark:text-gray-200 truncate';
        nameSpan.textContent = file.name;
        
        div.appendChild(nameSpan);
        div.innerHTML += `
            <div class="flex space-x-1 ml-1">
                <a href="/download/data/${encodeURIComponent(file.name)}" class="text-gray-600 hover:text-gray-800 text-sm" title="Descargar">‚¨áÔ∏è</a>
            </div>
        `;
        container.appendChild(div);
    });
}

function updateOutputFilesList(outputFiles) {
    const container = document.getElementById('output-files-list');
    if (!container) return;
    
    if (outputFiles.length === 0) {
        container.innerHTML = '<p class="text-xs text-gray-500 italic text-center">No hay documentos generados</p>';
        return;
    }
    
    container.innerHTML = '';
    outputFiles.forEach(file => {
        const div = document.createElement('div');
        div.className = 'flex justify-between items-center p-1 bg-gray-50 dark:bg-gray-700 rounded mb-1';
        
        const nameSpan = document.createElement('span');
        nameSpan.className = 'text-xs font-medium text-gray-800 dark:text-gray-200 truncate';
        nameSpan.textContent = file.name;
        
        div.appendChild(nameSpan);
        div.innerHTML += `
            <div class="flex space-x-1 ml-1">
                <a href="/download/output/${encodeURIComponent(file.name)}" class="text-gray-600 hover:text-gray-800 text-sm" title="Descargar">‚¨áÔ∏è</a>
            </div>
        `;
        container.appendChild(div);
    });
}


async function loadDocumentFiles() {
    try {
        // Asumo que hay una funci√≥n de backend /files/documents
        const response = await fetch('/files/documents');
        const data = await response.json();
        
        updateDocumentStats(data);
        updateTemplatesList(data.templates || []);
        updateDataFilesList(data.data_files || []);
        updateOutputFilesList(data.output_files || []);
    } catch (error) {
        console.error('Error cargando archivos de documentos:', error);
    }
}

function updateDocumentStats(data) {
    const statsElement = document.getElementById('document-stats');
    if (statsElement) {
        const templatesCount = data.templates ? data.templates.length : 0;
        const dataCount = data.data_files ? data.data_files.length : 0;
        const outputCount = data.output_files ? data.output_files.length : 0;
        statsElement.textContent = `Plantillas: ${templatesCount} | Datos: ${dataCount} | Generados: ${outputCount}`;
    }
}

// Funciones de subida (mantienen la l√≥gica as√≠ncrona)

async function uploadTemplate() {
    const fileInput = document.getElementById('template-file-input');
    const file = fileInput.files[0];
    
    if (!file) { showErrorMessage('Selecciona un archivo de plantilla'); return; }
    
    const formData = new FormData();
    formData.append('file', file);
    
    try {
        const response = await fetch('/upload/template', { method: 'POST', body: formData });
        const result = await response.json();
        
        if (result.success) {
            showSuccessMessage(result.message);
            if (result.next_step) { showInfoMessage(`üí° Siguiente paso: ${result.next_step}`); }
            loadDocumentFiles();
            fileInput.value = '';
        } else {
            showErrorMessage(result.error || 'Error subiendo plantilla');
        }
    } catch (error) {
        showErrorMessage(`Error de red subiendo plantilla: ${error.message}`);
    }
}

async function uploadDataFile() {
    const fileInput = document.getElementById('data-file-input');
    const file = fileInput.files[0];
    
    if (!file) { showErrorMessage('Selecciona un archivo de datos'); return; }
    
    const formData = new FormData();
    formData.append('file', file);
    
    try {
        const response = await fetch('/upload/data', { method: 'POST', body: formData });
        const result = await response.json();
        
        if (result.success) {
            showSuccessMessage(result.message);
            if (result.next_step) { showInfoMessage(`üí° Siguiente paso: ${result.next_step}`); }
            loadDocumentFiles();
            fileInput.value = '';
        } else {
            showErrorMessage(result.error || 'Error subiendo archivo');
        }
    } catch (error) {
        showErrorMessage(`Error de red subiendo archivo: ${error.message}`);
    }
}


// =============================================================================
// INICIALIZACI√ìN
// =============================================================================

document.addEventListener('DOMContentLoaded', function() {
    // Escuchar eventos personalizados del script.js principal para resultados RMN
    window.addEventListener('rmnCleanResult', function(event) {
        if (event.detail && event.detail.type === 'clean_result') {
            showCleanResult(event.detail);
        }
    });

    // Cargar estad√≠sticas iniciales al cargar el DOM
    loadRMNStats();
    loadDocumentFiles();
});
</script>

</body>
</html>