<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agente Gemini</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); }
        .entry { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-300">

<div class="container mx-auto p-4 md:p-8 flex flex-col md:flex-row h-screen">

    <!-- Contenido principal -->
    <div class="flex-1 bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 flex flex-col mr-0 md:mr-6 mb-6 md:mb-0 transition-colors duration-300">

        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-blue-600 dark:text-blue-400">ğŸ¤– Agente Gemini</h1>
            <div class="flex items-center space-x-2">
                <button id="guide-button" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 focus:outline-none hover:ring-2 ring-blue-500">â“</button>
                <button id="theme-toggle" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 focus:outline-none hover:ring-2 ring-blue-500">
                    <span id="theme-icon">ğŸŒ™</span>
                </button>
            </div>
        </div>

        <!-- Contenedor de guÃ­a e historial -->
        <div id="content-area" class="flex-1 overflow-y-auto scrollbar-hide">
            
            <!-- GuÃ­a de uso (oculta por defecto) -->
            <div id="guide" class="hidden mb-6 p-4 bg-blue-50 dark:bg-blue-900 rounded-lg">
                <h3 class="text-xl font-semibold mb-4 text-blue-800 dark:text-blue-200">ğŸ¤– GuÃ­a de uso del Agente Gemini</h3>
                
                <!-- Comandos RMN -->
                <div class="p-3 bg-teal-50 dark:bg-teal-900 rounded-lg mb-3">
                    <h4 class="font-bold text-teal-800 dark:text-teal-200 text-sm mb-2">ğŸ§ª RMN Spectrum Cleaner</h4>
                    <p class="text-xs font-mono text-teal-700 dark:text-teal-300 leading-relaxed">
                        rmn, espectro, espectros, resonancia, ruido, limpiar espectro, filtrar, savgol, gaussian, mediana, wiener, lÃ­nea base, snr, ppm, intensidad, picos, analizar espectro, comparar espectro, pfos, pfas, contaminante, array, cromatografia, espectrometria, masas, gc-ms, lc-ms
                    </p>
                </div>

                <!-- Sistema -->
                <div class="p-3 bg-green-50 dark:bg-green-900 rounded-lg mb-3">
                    <h4 class="font-bold text-green-800 dark:text-green-200 text-sm mb-2">âš™ï¸ System Control</h4>
                    <p class="text-xs font-mono text-green-700 dark:text-green-300 leading-relaxed">
                        control, verificar, consultar, activar, keywords, categories, status, estado, test, probar
                    </p>
                </div>

                <!-- Documentos -->
                <div class="p-3 bg-orange-50 dark:bg-orange-900 rounded-lg mb-3">
                    <h4 class="font-bold text-orange-800 dark:text-orange-200 text-sm mb-2">ğŸ“„ Document Filler</h4>
                    <p class="text-xs font-mono text-orange-700 dark:text-orange-300 leading-relaxed">
                        plantilla, rellenar, documento, formulario, listar plantillas, listar datos, analizar, crear ejemplo, ayuda, subvencion, subvenciÃ³n, document_filler, plantillas, datos, rellenar:
                    </p>
                </div>

                <!-- BÃºsqueda Web -->
                <div class="p-3 bg-blue-50 dark:bg-blue-900 rounded-lg mb-3">
                    <h4 class="font-bold text-blue-800 dark:text-blue-200 text-sm mb-2">ğŸ” Web Search</h4>
                    <p class="text-xs font-mono text-blue-700 dark:text-blue-300 leading-relaxed">
                        buscar, bÃºsqueda, search, google, encontrar, informaciÃ³n, noticias, artÃ­culos
                    </p>
                </div>

                <!-- Calculadora -->
                <div class="p-3 bg-purple-50 dark:bg-purple-900 rounded-lg mb-3">
                    <h4 class="font-bold text-purple-800 dark:text-purple-200 text-sm mb-2">ğŸ§® Calculator</h4>
                    <p class="text-xs text-purple-700 dark:text-purple-300">
                        <strong>DetecciÃ³n automÃ¡tica:</strong> Expresiones matemÃ¡ticas con nÃºmeros y operadores (+, -, *, /, **, %)
                    </p>
                </div>

                <!-- Notas -->
                <div class="p-3 bg-yellow-50 dark:bg-yellow-900 rounded-lg">
                    <h4 class="font-bold text-yellow-800 dark:text-yellow-200 text-sm mb-2">ğŸ“ File Manager (Notas y CÃ³digo)</h4>
                    <p class="text-xs text-yellow-700 dark:text-yellow-300 leading-relaxed">
                        <strong>Notas:</strong> guardar, leer, buscar, contar, borrar, nota<br>
                        <strong>CÃ³digo:</strong> formato â†’ archivo.py||codigo_aqui
                    </p>
                </div>
            </div>
            
            <!-- Historial de chat -->
            <div id="history" class="space-y-4">
                <!-- Las entradas del chat aparecerÃ¡n aquÃ­ -->
            </div>
        </div>

        <!-- Formulario de entrada -->
        <div class="mt-6">
            <form id="commandForm" class="flex space-x-2">
                <input type="text" id="user_input" placeholder="Escribe tu comando aquÃ­..." 
                       class="flex-1 px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg 
                              bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 
                              focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-300">
                <button type="submit" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-300">
                    Enviar
                </button>
            </form>
        </div>
    </div>

    <!-- Panel lateral -->
    <div class="w-full md:w-80 bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 transition-colors duration-300">
        <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-200">ğŸ“Š Panel de Control</h2>
        
        <!-- Usuario Info -->
        <div class="mb-6 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
            <h3 class="font-medium text-gray-800 dark:text-gray-200 mb-2">ğŸ‘¤ Usuario</h3>
            <p class="text-sm text-gray-600 dark:text-gray-300">ID: <span id="user-id">Cargando...</span></p>
        </div>

        <!-- EstadÃ­sticas -->
        <div class="mb-6 space-y-3">
            <h3 class="font-medium text-gray-800 dark:text-gray-200">ğŸ“ˆ EstadÃ­sticas</h3>
            
            <div class="p-2 bg-blue-50 dark:bg-blue-900 rounded">
                <div class="text-xs text-blue-700 dark:text-blue-300">Comandos ejecutados</div>
                <div class="font-bold text-blue-800 dark:text-blue-200" id="commands-count">0</div>
            </div>
            
            <div class="p-2 bg-green-50 dark:bg-green-900 rounded">
                <div class="text-xs text-green-700 dark:text-green-300">Notas guardadas</div>
                <div class="font-bold text-green-800 dark:text-green-200" id="notes-count">0</div>
            </div>
            
            <div class="p-2 bg-purple-50 dark:bg-purple-900 rounded">
                <div class="text-xs text-purple-700 dark:text-purple-300">Archivos de cÃ³digo</div>
                <div class="font-bold text-purple-800 dark:text-purple-200" id="code-count">0</div>
            </div>

            <div class="p-2 bg-orange-50 dark:bg-orange-900 rounded">
                <div class="text-xs text-orange-700 dark:text-orange-300">Notificaciones</div>
                <div class="font-bold text-orange-800 dark:text-orange-200" id="notifications-count">0</div>
            </div>
        </div>

        <!-- SecciÃ³n RMN -->
        <div class="mb-4">
            <button id="rmn-toggle" onclick="toggleRMNSection()" 
                    class="w-full p-3 bg-gradient-to-r from-teal-500 to-cyan-600 text-white rounded-lg hover:from-teal-600 hover:to-cyan-700 transition-all duration-300 font-medium">
                ğŸ§ª Espectros RMN â–¶
            </button>
        </div>

        <!-- Contenido RMN (oculto por defecto) -->
        <div id="rmn-section" class="hidden space-y-3">
            <div class="p-3 bg-teal-50 dark:bg-teal-900 rounded-lg">
                <h4 class="font-medium text-teal-800 dark:text-teal-200 mb-2">ğŸ“Š EstadÃ­sticas RMN</h4>
                <p class="text-xs text-teal-600 dark:text-teal-300" id="rmn-stats">Espectros: 0 | Limpios: 0 | GrÃ¡ficos: 0</p>
            </div>

            <div class="space-y-2">
                <button onclick="showRMNHelp()" 
                        class="w-full p-2 bg-teal-100 dark:bg-teal-800 text-teal-800 dark:text-teal-200 rounded text-sm hover:bg-teal-200 dark:hover:bg-teal-700 transition-colors">
                    â“ Ayuda RMN
                </button>
                
                <button onclick="showRMNMethods()" 
                        class="w-full p-2 bg-teal-100 dark:bg-teal-800 text-teal-800 dark:text-teal-200 rounded text-sm hover:bg-teal-200 dark:hover:bg-teal-700 transition-colors">
                    ğŸ§ª MÃ©todos disponibles
                </button>
                
                <button onclick="listSpectra()" 
                        class="w-full p-2 bg-teal-100 dark:bg-teal-800 text-teal-800 dark:text-teal-200 rounded text-sm hover:bg-teal-200 dark:hover:bg-teal-700 transition-colors">
                    ğŸ“‹ Listar espectros
                </button>
            </div>

            <!-- Comandos rÃ¡pidos RMN -->
            <div class="p-2 bg-gray-50 dark:bg-gray-700 rounded">
                <h5 class="text-xs font-medium text-gray-700 dark:text-gray-300 mb-2">âš¡ Comandos rÃ¡pidos:</h5>
                <div class="grid grid-cols-2 gap-1">
                    <button onclick="quickCleanAuto()" 
                            class="px-2 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600 transition-colors">
                        Auto
                    </button>
                    <button onclick="quickCleanSavgol()" 
                            class="px-2 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600 transition-colors">
                        Savgol
                    </button>
                    <button onclick="quickCleanGaussian()" 
                            class="px-2 py-1 bg-yellow-500 text-white text-xs rounded hover:bg-yellow-600 transition-colors">
                        Gaussian
                    </button>
                    <button onclick="quickCleanMedian()" 
                            class="px-2 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600 transition-colors">
                        Median
                    </button>
                </div>
            </div>

            <!-- Upload Ã¡rea para espectros -->
            <div class="p-3 border-2 border-dashed border-teal-300 dark:border-teal-600 rounded-lg">
                <input type="file" id="spectrum-upload" accept=".csv,.txt,.dat,.asc" class="hidden" 
                       onchange="uploadSpectrum(event)">
                <button onclick="document.getElementById('spectrum-upload').click()" 
                        class="w-full p-2 text-teal-600 dark:text-teal-400 text-sm hover:bg-teal-50 dark:hover:bg-teal-900 rounded transition-colors">
                    ğŸ“ Subir Espectro
                </button>
            </div>
        </div>

        <!-- Botones de acciÃ³n -->
        <div class="mt-6 space-y-3">
            <button onclick="showAllNotes()" 
                    class="w-full p-3 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-colors duration-300">
                ğŸ“ Ver Todas las Notas
            </button>
            
            <button onclick="showAllCode()" 
                    class="w-full p-3 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors duration-300">
                ğŸ’» Ver Todo el CÃ³digo
            </button>
            
            <button onclick="clearHistory()" 
                    class="w-full p-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors duration-300">
                ğŸ—‘ï¸ Limpiar Historial
            </button>
        </div>
    </div>
</div>

<!-- Modal para mostrar contenido completo -->
<div id="modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4">
        <div class="modal-overlay fixed inset-0" onclick="closeModal()"></div>
        <div class="relative bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-4xl w-full max-h-screen overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="modal-title" class="text-xl font-semibold text-gray-900 dark:text-gray-100">Contenido</h3>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 text-2xl">Ã—</button>
                </div>
                <div id="modal-content" class="text-gray-700 dark:text-gray-300">
                    <!-- Contenido dinÃ¡mico -->
                </div>
                <div class="mt-6 flex justify-end">
                    <button onclick="closeModal()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script>
// =============================================================================
// VARIABLES GLOBALES Y CONFIGURACIÃ“N
// =============================================================================
let commandCount = 0;
let userId = '';

// Generar ID de usuario Ãºnico
function generateUserId() {
    const stored = localStorage.getItem('gemini_user_id');
    if (stored) {
        userId = stored;
    } else {
        userId = 'user_' + Date.now().toString(36) + Math.random().toString(36).substr(2);
        localStorage.setItem('gemini_user_id', userId);
    }
    document.getElementById('user-id').textContent = userId;
}

// =============================================================================
// INICIALIZACIÃ“N
// =============================================================================
document.addEventListener('DOMContentLoaded', function() {
    generateUserId();
    loadTheme();
    updateAllStats();
    setupEventListeners();
});

function setupEventListeners() {
    // Form submission
    const form = document.getElementById('commandForm');
    const input = document.getElementById('user_input');
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const command = input.value.trim();
        if (command) {
            processCommand(command);
            input.value = '';
        }
    });

    // Theme toggle
    document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
    
    // Guide toggle
    document.getElementById('guide-button').addEventListener('click', function() {
        const guide = document.getElementById('guide');
        guide.classList.toggle('hidden');
    });
}

// =============================================================================
// PROCESAMIENTO DE COMANDOS
// =============================================================================
function processCommand(command) {
    commandCount++;
    localStorage.setItem('command_count', commandCount);
    updateAllStats();
    
    // Mostrar comando del usuario
    addToHistory(command, 'user');
    
    // Simular delay para respuesta
    setTimeout(() => {
        let response = handleCommand(command);
        addToHistory(response, 'assistant');
    }, 500);
}

function handleCommand(command) {
    const cmd = command.toLowerCase().trim();
    
    // Calculadora (detecciÃ³n automÃ¡tica)
    if (/^[\d+\-*/().\s%^]+$/.test(command) && /[\d]/test(command)) {
        try {
            const result = eval(command.replace(/\^/g, '**'));
            return `ğŸ§® **Resultado:** ${result}`;
        } catch {
            return `âŒ **Error de cÃ¡lculo:** ExpresiÃ³n matemÃ¡tica invÃ¡lida`;
        }
    }
    
    // GestiÃ³n de notas
    if (cmd.startsWith('guardar:')) {
        return saveNote(command.substring(8).trim());
    }
    if (cmd === 'leer' || cmd === 'ver notas') {
        return readNotes();
    }
    if (cmd.startsWith('buscar:')) {
        return searchNotes(command.substring(7).trim());
    }
    if (cmd === 'contar' || cmd === 'contar notas') {
        return countNotes();
    }
    if (cmd === 'borrar' || cmd === 'borrar notas') {
        return clearNotes();
    }
    
    // GestiÃ³n de cÃ³digo
    if (command.includes('||')) {
        return saveCode(command);
    }
    
    // URLs (detecciÃ³n automÃ¡tica)
    if (isURL(command)) {
        return handleURL(command);
    }
    
    // RMN Spectrum Cleaner
    if (isRMNCommand(cmd)) {
        return handleRMNCommand(command);
    }
    
    // Document Filler
    if (isDocumentCommand(cmd)) {
        return handleDocumentCommand(command);
    }
    
    // System Control
    if (isSystemCommand(cmd)) {
        return handleSystemCommand(command);
    }
    
    // BÃºsqueda web
    if (isSearchCommand(cmd)) {
        return handleWebSearch(command);
    }
    
    // Respuesta conversacional por defecto
    return generateConversationalResponse(command);
}

// =============================================================================
// GESTIÃ“N DE NOTAS
// =============================================================================
function saveNote(content) {
    if (!content) return 'âŒ **Error:** No se puede guardar una nota vacÃ­a';
    
    const notes = JSON.parse(localStorage.getItem('notes') || '[]');
    const note = {
        id: Date.now(),
        content: content,
        timestamp: new Date().toLocaleString('es-ES')
    };
    
    notes.push(note);
    localStorage.setItem('notes', JSON.stringify(notes));
    updateAllStats();
    
    return `âœ… **Nota guardada** (${note.timestamp})\n\nğŸ“ ${content}`;
}

function readNotes() {
    const notes = JSON.parse(localStorage.getItem('notes') || '[]');
    
    if (notes.length === 0) {
        return 'ğŸ“ **No hay notas guardadas**\n\nPuedes guardar una con: `guardar: tu nota aquÃ­`';
    }
    
    let response = `ğŸ“ **Tus notas (${notes.length})**\n\n`;
    notes.slice(-5).reverse().forEach((note, index) => {
        response += `**${index + 1}.** ${note.content}\n*${note.timestamp}*\n\n`;
    });
    
    if (notes.length > 5) {
        response += `*... y ${notes.length - 5} notas mÃ¡s. Usa "Ver Todas las Notas" para verlas.*`;
    }
    
    return response;
}

function searchNotes(term) {
    const notes = JSON.parse(localStorage.getItem('notes') || '[]');
    const results = notes.filter(note => 
        note.content.toLowerCase().includes(term.toLowerCase())
    );
    
    if (results.length === 0) {
        return `ğŸ” **Sin resultados** para "${term}"`;
    }
    
    let response = `ğŸ” **Encontradas ${results.length} notas con "${term}"**\n\n`;
    results.forEach((note, index) => {
        response += `**${index + 1}.** ${note.content}\n*${note.timestamp}*\n\n`;
    });
    
    return response;
}

function countNotes() {
    const notes = JSON.parse(localStorage.getItem('notes') || '[]');
    return `ğŸ“Š **Tienes ${notes.length} notas guardadas**`;
}

function clearNotes() {
    localStorage.removeItem('notes');
    updateAllStats();
    return 'ğŸ—‘ï¸ **Todas las notas han sido eliminadas**';
}

// =============================================================================
// GESTIÃ“N DE CÃ“DIGO
// =============================================================================
function saveCode(command) {
    const parts = command.split('||');
    if (parts.length !== 2) {
        return 'âŒ **Formato incorrecto**\n\nUsa: `archivo.py||tu cÃ³digo aquÃ­`';
    }
    
    const filename = parts[0].trim();
    const code = parts[1].trim();
    
    if (!filename || !code) {
        return 'âŒ **Error:** Nombre de archivo y cÃ³digo son requeridos';
    }
    
    const codeFiles = JSON.parse(localStorage.getItem('code_files') || '[]');
    const codeFile = {
        id: Date.now(),
        filename: filename,
        code: code,
        timestamp: new Date().toLocaleString('es-ES')
    };
    
    codeFiles.push(codeFile);
    localStorage.setItem('code_files', JSON.stringify(codeFiles));
    updateAllStats();
    
    // Crear archivo descargable
    const blob = new Blob([code], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    
    return `âœ… **Archivo guardado: ${filename}**\n\nğŸ’» \`\`\`${getLanguageFromExtension(filename)}\n${code}\n\`\`\`\n\nğŸ“¥ [Descargar ${filename}](${url})`;
}

function getLanguageFromExtension(filename) {
    const ext = filename.split('.').pop()?.toLowerCase();
    const langMap = {
        'py': 'python', 'js': 'javascript', 'html': 'html', 'css': 'css',
        'java': 'java', 'cpp': 'cpp', 'c': 'c'
    };
    return langMap[ext] || 'text';
}

// =============================================================================
// UTILIDADES Y DETECCIÃ“N
// =============================================================================
function isURL(text) {
    const urlPattern = /^(https?:\/\/)?([\da-z\.-]+)\.([a-z\.]{2,6})([\/\w \.-]*)*\/?$/i;
    return urlPattern.test(text) || text.includes('.com') || text.includes('.org') || text.includes('.es');
}

function handleURL(url) {
    if (!url.startsWith('http')) url = 'https://' + url;
    window.open(url, '_blank');
    return `ğŸŒ **Abriendo enlace:** ${url}\n\nâœ¨ La pÃ¡gina se ha abierto en una nueva pestaÃ±a`;
}

function isRMNCommand(cmd) {
    const rmnKeywords = ['rmn', 'espectro', 'resonancia', 'ruido', 'limpiar', 'filtrar', 'savgol', 'gaussian', 'mediana', 'wiener', 'ppm', 'intensidad', 'picos', 'pfos', 'pfas'];
    return rmnKeywords.some(keyword => cmd.includes(keyword));
}

function handleRMNCommand(command) {
    return `ğŸ§ª **RMN Spectrum Cleaner activado**\n\nComando detectado: "${command}"\n\nâš™ï¸ Procesando espectro...\nğŸ“Š AnÃ¡lisis de ruido completado\nğŸ”§ Aplicando filtros automÃ¡ticos\nâœ… Espectro limpio generado\n\nğŸ“ˆ **Mejora del SNR:** +85%\nğŸ“‰ **ReducciÃ³n de ruido:** 73%\n\nğŸ’¡ *Nota: Esta es una simulaciÃ³n. Conecta con tu backend para procesamiento real.*`;
}

function isDocumentCommand(cmd) {
    const docKeywords = ['plantilla', 'rellenar', 'documento', 'formulario', 'subvencion', 'datos'];
    return docKeywords.some(keyword => cmd.includes(keyword));
}

function handleDocumentCommand(command) {
    return `ğŸ“„ **Document Filler activado**\n\nComando: "${command}"\n\nğŸ“‹ Plantillas disponibles: 3\nğŸ“Š Archivos de datos: 7\nğŸ”„ Procesando documento...\nâœ… Documento rellenado exitosamente\n\nğŸ“ **Resultado:** documento_completo.docx\nğŸ“¥ **TamaÃ±o:** 2.3 MB\n\nğŸ’¡ *SimulaciÃ³n activa. Conecta tu backend para funcionalidad completa.*`;
}

function isSystemCommand(cmd) {
    const sysKeywords = ['control', 'verificar', 'status', 'estado', 'test', 'probar', 'activar'];
    return sysKeywords.some(keyword => cmd.includes(keyword));
}

function handleSystemCommand(command) {
    return `âš™ï¸ **System Control Panel**\n\nComando: "${command}"\n\nğŸŸ¢ **Estado del sistema:** Operativo\nğŸ”§ **Herramientas activas:** 6/6\nğŸ“Š **Uso de memoria:** 47%\nğŸŒ **ConexiÃ³n:** Estable\n\nâœ… **Verificaciones completadas**\n- RMN Cleaner: âœ“\n- Document Filler: âœ“ \n- Web Search: âœ“\n- File Manager: âœ“\n- Calculator: âœ“\n- Notifications: âœ“`;
}

function isSearchCommand(cmd) {
    const searchKeywords = ['buscar', 'bÃºsqueda', 'search', 'google', 'encontrar', 'informaciÃ³n'];
    return searchKeywords.some(keyword => cmd.includes(keyword));
}

function handleWebSearch(command) {
    const searchResults = [
        "InvestigaciÃ³n sobre inteligencia artificial en 2024",
        "Avances en machine learning y deep learning",
        "Nuevas tecnologÃ­as emergentes",
        "Desarrollos en computaciÃ³n cuÃ¡ntica"
    ];
    
    const randomResults = searchResults.sort(() => 0.5 - Math.random()).slice(0, 3);
    
    let response = `ğŸ” **Resultados de bÃºsqueda para:** "${command}"\n\n`;
    randomResults.forEach((result, index) => {
        response += `**${index + 1}.** ${result}\n`;
    });
    
    response += `\nğŸŒ **${randomResults.length} resultados encontrados**\nğŸ’¡ *SimulaciÃ³n activa. Conecta API de bÃºsqueda para resultados reales.*`;
    
    return response;
}

function generateConversationalResponse(input) {
    const responses = [
        `ğŸ¤– Interesante pregunta sobre "${input}". Como agente Gemini, estoy aquÃ­ para ayudarte con anÃ¡lisis de datos, gestiÃ³n de documentos, cÃ¡lculos y mÃ¡s.`,
        `ğŸ’­ Entiendo que preguntas sobre "${input}". Â¿Te gustarÃ­a que te ayude con alguna tarea especÃ­fica? Puedo procesar espectros RMN, rellenar documentos o hacer cÃ¡lculos.`,
        `ğŸš€ "${input}" suena fascinante. Mis especialidades incluyen limpieza de espectros, anÃ¡lisis de datos, gestiÃ³n de archivos y bÃºsquedas web. Â¿En quÃ© puedo asistirte?`,
        `âœ¨ Respecto a "${input}", puedo ayudarte de muchas formas. Prueba comandos como calculadora, notas, o consulta la guÃ­a con el botÃ³n â“.`
    ];
    
    return responses[Math.floor(Math.random() * responses.length)];
}

// =============================================================================
// GESTIÃ“N DE HISTORIAL Y UI
// =============================================================================
function addToHistory(content, sender) {
    const history = document.getElementById('history');
    const entry = document.createElement('div');
    
    if (sender === 'user') {
        entry.className = 'entry p-4 bg-blue-50 dark:bg-blue-900 rounded-lg shadow-md border-l-4 border-blue-500 ml-8';
        entry.innerHTML = `
            <div class="flex items-center mb-2">
                <span class="text-blue-600 dark:text-blue-400 font-medium">ğŸ‘¤ Usuario</span>
                <span class="text-xs text-gray-500 ml-2">${new Date().toLocaleTimeString()}</span>
            </div>
            <div class="text-gray-800 dark:text-gray-200">${content}</div>
        `;
    } else {
        entry.className = 'entry p-4 bg-green-50 dark:bg-green-900 rounded-lg shadow-md border-l-4 border-green-500 mr-8';
        entry.innerHTML = `
            <div class="flex items-center mb-2">
                <span class="text-green-600 dark:text-green-400 font-medium">ğŸ¤– Gemini Agent</span>
                <span class="text-xs text-gray-500 ml-2">${new Date().toLocaleTimeString()}</span>
            </div>
            <div class="text-gray-800 dark:text-gray-200 whitespace-pre-wrap">${formatResponse(content)}</div>
        `;
    }
    
    history.appendChild(entry);
    history.scrollTop = history.scrollHeight;
}

function formatResponse(content) {
    // Convertir markdown bÃ¡sico a HTML
    return content
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/`(.*?)`/g, '<code class="bg-gray-200 dark:bg-gray-700 px-1 rounded text-sm">$1</code>')
        .replace(/```(\w+)?\n(.*?)```/gs, '<pre class="bg-gray-100 dark:bg-gray-800 p-3 rounded mt-2 overflow-x-auto"><code>$2</code></pre>')
        .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" class="text-blue-500 hover:underline" target="_blank">$1</a>');
}

// =============================================================================
// GESTIÃ“N DE TEMA
// =============================================================================
function toggleTheme() {
    const html = document.documentElement;
    const themeIcon = document.getElementById('theme-icon');
    
    if (html.classList.contains('dark')) {
        html.classList.remove('dark');
        themeIcon.textContent = 'ğŸŒ™';
        localStorage.setItem('theme', 'light');
    } else {
        html.classList.add('dark');
        themeIcon.textContent = 'â˜€ï¸';
        localStorage.setItem('theme', 'dark');
    }
}

function loadTheme() {
    const savedTheme = localStorage.getItem('theme') || 'light';
    const html = document.documentElement;
    const themeIcon = document.getElementById('theme-icon');
    
    if (savedTheme === 'dark') {
        html.classList.add('dark');
        themeIcon.textContent = 'â˜€ï¸';
    } else {
        html.classList.remove('dark');
        themeIcon.textContent = 'ğŸŒ™';
    }
}

// =============================================================================
// ESTADÃSTICAS Y CONTADORES
// =============================================================================
function updateAllStats() {
    updateCommandsCount();
    updateNotesCount();
    updateCodeCount();
    updateNotificationsCount();
}

function updateCommandsCount() {
    const count = localStorage.getItem('command_count') || 0;
    document.getElementById('commands-count').textContent = count;
}

function updateNotesCount() {
    const notes = JSON.parse(localStorage.getItem('notes') || '[]');
    document.getElementById('notes-count').textContent = notes.length;
}

function updateCodeCount() {
    const codeFiles = JSON.parse(localStorage.getItem('code_files') || '[]');
    document.getElementById('code-count').textContent = codeFiles.length;
}

function updateNotificationsCount() {
    const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
    document.getElementById('notifications-count').textContent = notifications.length;
}

// =============================================================================
// FUNCIONES RMN (Panel lateral)
// =============================================================================
function toggleRMNSection() {
    const section = document.getElementById('rmn-section');
    const button = document.getElementById('rmn-toggle');
    
    if (section.classList.contains('hidden')) {
        section.classList.remove('hidden');
        button.innerHTML = 'ğŸ§ª Espectros RMN â–¼';
        button.classList.add('from-cyan-600', 'to-teal-700');
    } else {
        section.classList.add('hidden');
        button.innerHTML = 'ğŸ§ª Espectros RMN â–¶';
        button.classList.remove('from-cyan-600', 'to-teal-700');
    }
}

function showRMNHelp() {
    processCommand('ayuda rmn');
}

function showRMNMethods() {
    processCommand('mÃ©todos limpieza rmn');
}

function listSpectra() {
    processCommand('listar espectros rmn');
}

function executeRMNCommand() {
    const input = document.getElementById('user_input');
    input.focus();
    input.value = 'rmn ';
}

function quickCleanAuto() {
    processCommand('limpiar espectro auto');
}

function quickCleanSavgol() {
    processCommand('limpiar espectro savgol');
}

function quickCleanGaussian() {
    processCommand('limpiar espectro gaussian');
}

function quickCleanMedian() {
    processCommand('limpiar espectro mediana');
}

function uploadSpectrum(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const content = e.target.result;
            // Simular procesamiento
            processCommand(`subir espectro: ${file.name}`);
        };
        reader.readAsText(file);
    }
}

function loadRMNStats() {
    // SimulaciÃ³n de estadÃ­sticas RMN
    const spectraCount = Math.floor(Math.random() * 10) + 1;
    const cleanedCount = Math.floor(spectraCount * 0.7);
    const plotsCount = Math.floor(cleanedCount * 0.8);
    
    document.getElementById('rmn-stats').textContent = 
        `Espectros: ${spectraCount} | Limpios: ${cleanedCount} | GrÃ¡ficos: ${plotsCount}`;
}

// =============================================================================
// FUNCIONES MODAL Y VISTAS
// =============================================================================
function showModal(title, content) {
    document.getElementById('modal-title').textContent = title;
    document.getElementById('modal-content').innerHTML = formatResponse(content);
    document.getElementById('modal').classList.remove('hidden');
}

function closeModal() {
    document.getElementById('modal').classList.add('hidden');
}

function showAllNotes() {
    const notes = JSON.parse(localStorage.getItem('notes') || '[]');
    
    if (notes.length === 0) {
        showModal('ğŸ“ Notas', 'No hay notas guardadas.\n\nPuedes crear una nueva con: guardar: tu nota aquÃ­');
        return;
    }
    
    let content = `**Total de notas: ${notes.length}**\n\n`;
    notes.reverse().forEach((note, index) => {
        content += `**${index + 1}.** ${note.content}\n*${note.timestamp}*\n\n`;
    });
    
    showModal('ğŸ“ Todas las Notas', content);
}

function showAllCode() {
    const codeFiles = JSON.parse(localStorage.getItem('code_files') || '[]');
    
    if (codeFiles.length === 0) {
        showModal('ğŸ’» CÃ³digo', 'No hay archivos de cÃ³digo guardados.\n\nPuedes crear uno con: archivo.py||print("Hola mundo")');
        return;
    }
    
    let content = `**Total de archivos: ${codeFiles.length}**\n\n`;
    codeFiles.reverse().forEach((file, index) => {
        content += `**${index + 1}. ${file.filename}**\n\`\`\`${getLanguageFromExtension(file.filename)}\n${file.code}\n\`\`\`\n*${file.timestamp}*\n\n`;
    });
    
    showModal('ğŸ’» Todos los Archivos de CÃ³digo', content);
}

function clearHistory() {
    if (confirm('Â¿EstÃ¡s seguro de que quieres limpiar el historial?')) {
        document.getElementById('history').innerHTML = '';
        addToHistory('ğŸ—‘ï¸ Historial limpiado correctamente', 'assistant');
    }
}

// =============================================================================
// EVENTOS GLOBALES
// =============================================================================

// Cerrar modal con ESC
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeModal();
    }
});

// Auto-focus en el input cuando se presiona cualquier tecla
document.addEventListener('keydown', function(e) {
    const input = document.getElementById('user_input');
    if (e.target !== input && !e.ctrlKey && !e.altKey && e.key.length === 1) {
        input.focus();
    }
});

// Inicializar estadÃ­sticas RMN
setTimeout(loadRMNStats, 1000);

// =============================================================================
// MENSAJE DE BIENVENIDA
// =============================================================================
setTimeout(() => {
    addToHistory('Â¡Bienvenido al Agente Gemini! ğŸš€\n\nEstoy listo para ayudarte con:\nâ€¢ ğŸ§® CÃ¡lculos matemÃ¡ticos\nâ€¢ ğŸ“ GestiÃ³n de notas\nâ€¢ ğŸ’» Archivos de cÃ³digo\nâ€¢ ğŸ§ª AnÃ¡lisis de espectros RMN\nâ€¢ ğŸ“„ Procesamiento de documentos\nâ€¢ ğŸ” BÃºsquedas web\nâ€¢ âš™ï¸ Control del sistema\n\nğŸ’¡ **Tip:** Haz clic en â“ para ver la guÃ­a completa de comandos.', 'assistant');
}, 1000);

</script>

</body>
</html>